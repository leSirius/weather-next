## home请求链
home页面关键路径过长，有三个存在依赖的请求，获取地理位置->获取id->获取天气信息，一般在load事件之后才发起获取id的请求，而且地理位置需要用户许可权限才可以拿。
对比之下，search和home几乎需要一样的数据量来渲染页面，search通常快一些。search实际多一个热门城市列表的请求，但有流式渲染并行进行，没有影响。

### 改进

因为地理位置必须在客户端请求权限获取，没找到太好的方案，试了下中间件把默认页面改成search页面，search页面来请求用户权限，拿到位置存进sessionStorage，切换到home时，直接从存储拿位置，在这种情况下可以省去第一个请求。
用useLayoutEffect会有五到十毫秒的微小提前，骨架屏在html里绘制好了，所以useLayoutEffect同步执行在这里没有影响。

后续对id的请求依赖没有继续优化。一个应该可行的优化方案是，在服务端缓存地理信息与id，这样客户端从sessionStorage获取地理信息后就可以直接请求天气信息，在理想情况下（从search跳转home后），可以消解掉请求链。

# search页面

流式渲染下DCL指标不是很好看，因为渲染的过程也是等待数据的过程，到DCL发出时，页面数据基本绘制完成。home页面常要到load事件以后才发出数据请求。

## 切换数据延迟优化
在home页面中，中间组件(MiddleBoard)切换数据种类的按钮点击会请求数据，所以存在一点延迟。这里结合了服务端和客户端抓取数据，模仿Next.js `<Link>`的预抓取方法，SWR策略，以及使用`If-Non-Match`请求头（本来数据也蛮小的）进行了优化。

Middle组件的初始渲染数据（每次url发生变化时）总是由服务端组件提供，客户端组件监听load事件（后续是useEffect监听id），预抓取其余两种数据进入缓存。每当切换数据种类时，先检查缓存，如果没有数据就发起请求；有则直接呈现缓存数据，然后使用数据更新时间作`If-Non-Match`的值发送请求，过期返回新数据，未过期返回304。切换城市会重复该流程。
大多数时候服务器也不会向数据源校验，这里还有一层Next.js的Data Cache缓存，设置每小时才会向数据源校验一次。不过这种基于时间的校验策略似乎存在一个纰漏，当一个数据需要校验时，服务器收到请求还是会直接回旧数据，然后向数据源发起校验，所以这次的数据请求很可能是过时的。

## Issues

需要测试慢网速的情景，特别是节流下的快速点击。处理回应时，检查该回应是否需要被废弃。在处理异步回应时，如果使用了每次渲染重计算的值，这些参数可能会在请求与回复的等待过程中被修改而失效。

在page组件中使用导入 Context.Provider 越过服务端组件向两棵子树的叶组件传参，实现在url中设置witch数据种类（原本只能设置城市id，导致现实的数据种类重置回第一个）。
只有城市列表可以改变url，使用服务端抓取的数据；在Middle点选数据类型时使用fetch发起请求，不修改url修改，这会导致url与的当前显示不匹配。而且，改变url的初始渲染总是使用服务端抓取数据，不能最大化利用缓存。

state连锁更新。点选按钮切换，如果先改witchFetch状态（数据种类），然后引起监听这个变量的呈现数据（showData）状态的改变，会引起至少两次react渲染，不太必要，且容易出问题。在两次渲染切割的三个时间片中，中间时间片的数据是不相匹配的。
state监听渲染遇到新的setState会适时停止，不再调用子组件。
（这只是可以同步获取数据的情况，如果所切换的数据尚未缓存，第二个时间片要到异步请求的数据到达才结束，React渲染会执行完中间时间片导致报错。因为有预抓取，在正常网速下这个情况不太会发生）

自定义钩子实现没有具备泛用性，跟数据嵌合严重。

# 杂项
## 轮播图

参照B站网页执行情况实现。基本思路是每次移动将图片墙左移，显示位置从1滑动到2，然后将开头的图片挪到末尾，恢复显示位置到1；图片墙右移位置在1和0之间切换。定时器交替设置为1500ms和350ms（动画执行时间为300ms）。
//左移流程 slideOn=true -> viewport slides from 1 to 2 with animation(300ms), timer350ms -> itemList left shifts, slideOn=false ->viewport from 2 to 1 without animation->1500ms -> slideOn=true...

## 日出日落信息
canvas绘制动画，折线的绘制考虑了刷新率适配。闪烁动画通过计算imageData坐标实现。图片存在清晰度问题，canvas的缩放比和坐标偏移没被考虑。

## 组件复用

home页面做了响应式适配。 home和search主要是抓取数据方式不同，样式基本是同一套。但一部分代码直接复制使用，冗余较多。如果给它们加专门抓取数据的中间层，或者统一在page组件抓取，子组件基本都可以直接复用。

文件组织有些杂乱：数据抓取有两种方式，且工具函数存放不集中，组件全写进UI文件夹不是很方便切换